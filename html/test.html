<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 5.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
	<head>
		<meta name="description" content="" >
		<meta name="author" content="Matthew Martin">
		<meta name="keywords" content="" >
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<meta http-equiv="Expires" content="Mon, 26 Jul 1980 05:00:00 GMT">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="Cache-Control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
		<meta http-equiv="Cache-Control" content="max-age=0">
		<title>PAM RemoteApi Example</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.2.9/justgage.min.js"></script>
		<script type="text/javascript" language="javascript">
			
			var url = new URL(window.location.href);
			var g_endpoint = url.searchParams.get("endpoint");
			
			
			console.log(g_endpoint);
			if(g_endpoint === null)
			{
				g_endpoint = prompt("Enter endpoint");
			}
			
			var g_url = "http://"+g_endpoint+"/x-pam";
			var g_canvas;


			function on_load()
			{
				g_canvas = document.getElementById('fft');

				ws_connect();
			}
			function ws_connect()
			{
				console.log("ws_connect: "+ g_endpoint+"/x-pam/monitor");
				g_ws = new WebSocket('ws://'+ g_endpoint+"/x-pam/monitor");
				
				g_ws.onopen = function(ev)  { console.log(ev); };
				g_ws.onerror = function(ev) { console.log(ev); };
				g_ws.onclose = function(ev) { console.log(ev); alert("Server has closed");};
				//g_ws.filter = function(jsonObj){};
	
							
				g_ws.onmessage = function(ev) 
				{
					var jsonObj = JSON.parse(ev.data);
					if(jsonObj["plugin"] !== undefined)
					{
						console.log(jsonObj["plugin"]["name"]);
						if(jsonObj["plugin"]["name"] == "Meters")
						{
							drawMeter(jsonObj["data"]);
						}
						else if(jsonObj["plugin"]["name"] == "FFT")
						{
							drawfft(jsonObj["data"]);
						}	
						else if(jsonObj["plugin"]["name"] == "R128")
						{
							showR128(jsonObj["data"]);
						}
						else if(jsonObj["plugin"]["name"] == "Specto")
						{
							drawSpecto(jsonObj["data"]);
						}
						else if(jsonObj["plugin"]["name"] == "Radar")
						{
							drawRadar(jsonObj["data"]);
						}
						else if(jsonObj["plugin"]["name"] == "Session Info")
						{
							//drawRadar(jsonObj["data"]);
						}
						else
						{
						//	console.log(jsonObj);
						}
					}
                }
            }

			function prepareCanvas()
			{
				var ctx = g_canvas.getContext('2d');
				ctx.fillStyle = '#000000';
				ctx.fillRect(0,0,g_canvas.width, g_canvas.height);
				return ctx;
			}

			function drawMeter(jsonObj)
			{
				var ctx = prepareCanvas();

				var y = -(g_canvas.height/70.0 * jsonObj[0]["level"]);
				ctx.fillStyle = '#ff0000';
				ctx.fillRect(40, y, 50, g_canvas.height-y);

				y = -(g_canvas.height/70.0 * jsonObj[1]["level"]);
				ctx.fillStyle = '#00ff00';
				ctx.fillRect(100, y, 50, g_canvas.height-y);

				y = -(g_canvas.height/70.0 * jsonObj[2]["level"]);
				ctx.fillStyle = '#ffffff';
				ctx.fillRect(180, y, 50, g_canvas.height-y);

				y = -(g_canvas.height/70.0 * jsonObj[3]["level"]);
				ctx.fillStyle = '#ff8800';
				ctx.fillRect(240, y, 50, g_canvas.height-y);

			}

			var xOld;
			var yOld;
			var xMaxOld;
			var yMaxOld;

			function drawRadar(jsonObj)
			{
				console.log(jsonObj);
				if(jsonObj["max"] !== undefined && jsonObj["radar"] !== undefined)
				{
					var ctx = g_canvas.getContext('2d');
					if(xOld === null)
					{
						ctx.strokeStyle = '#000000';
						ctx.beginPath();
						ctx.moveTo(g_canvas.width/2, g_canvas.height/2);
						ctx.lineTo(g_canvas.width/2+jsonObj["max"]["x"], g_canvas.height/2+jsonObj["max"]["y"]);	
						ctx.stroke();
						
						//ctx = g_canvas.getContext('2d');
						ctx.strokeStyle = '#00ff00';
						ctx.beginPath();
						
						ctx.moveTo(g_canvas.width/2, g_canvas.height/2);
						ctx.lineTo(g_canvas.width/2+jsonObj["radar"]["x"], g_canvas.height/2+jsonObj["radar"]["y"]);	
						ctx.stroke();
					}
					else
					{
						ctx.fillStyle = '#000000';
						ctx.strokeStyle = '#000000';
						ctx.beginPath();
						ctx.moveTo(g_canvas.width/2, g_canvas.height/2);
						ctx.lineTo(xMaxOld, yMaxOld);
						ctx.lineTo(g_canvas.width/2+jsonObj["max"]["x"], g_canvas.height/2+jsonObj["max"]["y"]);	
						ctx.lineTo(g_canvas.width/2, g_canvas.height/2);
						ctx.fill();

						ctx.fillStyle = '#00ff00';
						ctx.strokeStyle = '#00ff00';
						ctx.beginPath();
						ctx.moveTo(g_canvas.width/2, g_canvas.height/2);
						ctx.lineTo(xOld, yOld);
						ctx.lineTo(g_canvas.width/2+jsonObj["radar"]["x"], g_canvas.height/2+jsonObj["radar"]["y"]);	
						ctx.lineTo(g_canvas.width/2, g_canvas.height/2);
						ctx.fill();

					}
					xOld = g_canvas.width/2+jsonObj["radar"]["x"];
					yOld = g_canvas.height/2+jsonObj["radar"]["y"];

					xMaxOld = g_canvas.width/2+jsonObj["max"]["x"];
					yMaxOld = g_canvas.height/2+jsonObj["max"]["y"];


				}
				else
				{
					console.log(jsonObj);
				}
			}
			function drawfft(jsonObj)
			{
				var ctx = prepareCanvas();
				ctx.strokeStyle = '#ffffff';
				ctx.beginPath();
				ctx.moveTo(0,0);
				ctx.lineTo(0, g_canvas.height);
				ctx.lineTo(g_canvas.width, g_canvas.height);
				ctx.stroke();

				if(jsonObj["bins"] !== undefined)
				{
					
					ctx.beginPath();
					var oldx = 0;
					var oldy = 0;
					for(var i = 0; i < jsonObj["bins"].length; i++)
					{
						var x = g_canvas.width/Math.log10(jsonObj["bins"].length) * Math.log10(i);
						var y = -(g_canvas.height/70.0 * jsonObj["bins"][i]["level"]);
        				
						ctx.moveTo(oldx, oldy);
						ctx.lineTo(x,y);

						oldx = x;
						oldy = y;
					}
					ctx.stroke();
				}
			}
			function drawSpecto(jsonObj)
			{
				console.log("drawSpecto");
			}

			function showR128(jsonObj)
			{
				console.log("showR128");
			}

        </script>
    </head>
    <body onload="on_load()">
		<canvas id="fft" width="1024" height="600">Fallback</canvas>
    </body>
</HTML>